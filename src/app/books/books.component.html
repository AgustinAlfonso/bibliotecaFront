<div class="wrap">
  <!-- Banner de diagnÃ³stico -->
  <div *ngIf="!apiStatus().ok" class="api-banner" role="alert" aria-live="assertive">
    {{ apiStatus().msg }}
    <small>RevisÃ¡ CORS, la URL base y que el backend estÃ© arriba.</small>
  </div>

  <header class="topbar">
    <h1>ðŸ“š Biblioteca</h1>

    <div class="filters">
      <!-- Buscador (tÃ­tulo o autor) -->
      <div class="search">
        <label for="search-input">Buscar</label>
        <input
          id="search-input"
          type="text"
          [value]="search()"
          (input)="onSearchInput($any($event.target).value)"
          placeholder="TÃ­tulo o autorâ€¦"
          autocomplete="off"
          aria-label="Buscar libros por tÃ­tulo o autor"
        />
        <button
          *ngIf="search()"
          class="clear-x"
          (click)="clearSearch()"
          aria-label="Limpiar bÃºsqueda"
          type="button">âœ•</button>
      </div>

      <!-- GÃ©nero -->
      <div class="ac">
        <label for="genre-select">GÃ©nero</label>
        <select
          id="genre-select"
          [disabled]="taxoLoading() || genres().length === 0"
          [value]="genreFilter()"
          (change)="onGenreChange($event)"
          aria-label="Filtrar por gÃ©nero">
          <option value="">Todos</option>
          <option *ngFor="let g of genres(); trackBy: trackByText" [value]="g">{{ g }}</option>
        </select>
        <button
          *ngIf="genreFilter()"
          class="clear-x"
          (click)="clearGenre()"
          aria-label="Limpiar filtro de gÃ©nero"
          type="button">âœ•</button>
      </div>
    </div>

    <div class="meta">
      <span>PÃ¡g. {{ currentPage() }} Â· Mostrando {{ visibleBooks().length }} / {{ total() | number }}</span>
    </div>
  </header>

  <!-- Aâ€“Z + # : filtro server-side por primera letra del TÃTULO -->
  <div class="azbar" role="toolbar" aria-label="Filtro por letra inicial">
    <button
      *ngFor="let l of letters"
      (click)="toggleLetter(l)"
      [class.active]="letterFilter() === l"
      [attr.aria-pressed]="letterFilter() === l"
      type="button"
      [attr.aria-label]="'Filtrar por letra ' + l">
      {{ l }}
    </button>
    <button
      *ngIf="letterFilter()"
      class="clear"
      (click)="clearLetter()"
      aria-label="Limpiar filtro de letra"
      type="button">Limpiar</button>
  </div>

  <div #scroller class="scroller" role="region" aria-label="Lista de libros" tabindex="0">
    <table class="grid" *ngIf="visibleBooks().length || loading()">
      <thead>
      <tr>
        <th scope="col">TÃ­tulo</th>
        <th scope="col">Autor</th>
        <th scope="col">GÃ©nero</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let b of visibleBooks(); trackBy: trackById">
        <td>
          <div class="download-container">
            <button
              type="button"
              class="download-btn"
              (click)="toggleDownloadMenu(b.id, $event)"
              [attr.aria-expanded]="openDownloadMenu() === b.id"
              [attr.aria-label]="'Opciones de descarga para ' + b.title">
              {{ b.title }}
              <span class="download-icon">â–¼</span>
            </button>
            <div
              *ngIf="openDownloadMenu() === b.id"
              class="download-menu"
              (click)="$event.stopPropagation()">
              <button
                type="button"
                class="download-option"
                (click)="downloadEpub(b.id, b.filename, $event)"
                [attr.aria-label]="'Descargar ' + b.title + ' en formato EPUB'">
                ðŸ“– Descargar EPUB
              </button>
              <button
                type="button"
                class="download-option"
                (click)="downloadPdf(b.id, b.filename, $event)"
                [attr.aria-label]="'Descargar ' + b.title + ' en formato PDF'">
                ðŸ“„ Descargar PDF
              </button>
            </div>
          </div>
        </td>
        <td>{{ b.author ?? 'â€”' }}</td>
        <td>{{ b.genre ?? 'â€”' }}</td>
      </tr>

      <!-- Skeleton -->
      <tr *ngIf="loading()" class="sk" aria-hidden="true">
        <td colspan="3">
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
        </td>
      </tr>
      </tbody>
    </table>

    <div class="status" *ngIf="!visibleBooks().length && !loading()" role="status" aria-live="polite">
      Sin resultados
    </div>
    <div #bottomSentinel class="sentinel" aria-hidden="true"></div>
  </div>
</div>
