<div class="wrap">
  <!-- Banner de diagnóstico -->
  <div *ngIf="!apiStatus().ok" class="api-banner" role="alert" aria-live="assertive">
    {{ apiStatus().msg }}
    <small>Revisá CORS, la URL base y que el backend esté arriba.</small>
  </div>

  <header class="topbar">
    <h1>
      <img src="assets/images/libros.png" alt="Libros apilados" class="title-icon" />
      La Totalidad De Todo Lo Jamás Escrito
    </h1>

    <div class="filters">
      <!-- Buscador (título o autor) -->
      <div class="search">
        <label for="search-input">Buscar</label>
        <input
          id="search-input"
          type="text"
          [value]="search()"
          (input)="onSearchInput($any($event.target).value)"
          placeholder="Título o autor…"
          autocomplete="off"
          aria-label="Buscar libros por título o autor"
        />
      </div>

      <!-- Género -->
      <div class="ac">
        <label for="genre-select">Género</label>
        <div class="custom-dropdown" (click)="$event.stopPropagation()">
          <button
            type="button"
            id="genre-select"
            class="dropdown-button"
            [disabled]="taxoLoading() || genres().length === 0"
            (click)="toggleGenreDropdown()"
            [attr.aria-expanded]="genreDropdownOpen()"
            aria-label="Filtrar por género"
            aria-haspopup="listbox">
            {{ genreFilter() || 'Todos' }}
            <span class="dropdown-arrow">▼</span>
          </button>
          <ul
            *ngIf="genreDropdownOpen() && !taxoLoading() && genres().length > 0"
            class="dropdown-menu"
            role="listbox">
            <li
              role="option"
              class="dropdown-option"
              [class.active]="!genreFilter()"
              (click)="selectGenre('')"
              [attr.aria-selected]="!genreFilter()">
              Todos
            </li>
            <li
              *ngFor="let g of genres(); trackBy: trackByText"
              role="option"
              class="dropdown-option"
              [class.active]="genreFilter() === g"
              (click)="selectGenre(g)"
              [attr.aria-selected]="genreFilter() === g">
              {{ g }}
            </li>
          </ul>
        </div>
      </div>

      <!-- Botón Limpiar Filtros -->
      <button
        type="button"
        class="clear-filters-btn"
        [disabled]="!hasActiveFilters()"
        (click)="clearAllFilters()"
        aria-label="Limpiar todos los filtros">
        Limpiar filtros
      </button>
    </div>

    <div class="meta">
      <span>Pág. {{ visiblePage() }} · Mostrando {{ visibleBooks().length }} / {{ total() | number }}</span>
    </div>
  </header>

  <!-- A–Z + # : filtro server-side por primera letra del TÍTULO -->
  <div class="azbar" role="toolbar" aria-label="Filtro por letra inicial">
    <button
      *ngFor="let l of letters"
      (click)="toggleLetter(l)"
      [class.active]="letterFilter() === l"
      [attr.aria-pressed]="letterFilter() === l"
      type="button"
      [attr.aria-label]="'Filtrar por letra ' + l">
      {{ l }}
    </button>
    <button
      *ngIf="letterFilter()"
      class="clear"
      (click)="clearLetter()"
      aria-label="Limpiar filtro de letra"
      type="button">Limpiar</button>
  </div>

  <div #scroller class="scroller" role="region" aria-label="Lista de libros" tabindex="0">
    <table class="grid" *ngIf="visibleBooks().length || loading()">
      <thead>
      <tr>
        <th scope="col">Título</th>
        <th scope="col">Autor</th>
        <th scope="col">Género</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let b of visibleBooks(); trackBy: trackById">
        <td>
          <div class="download-container">
            <button
              type="button"
              class="download-btn"
              (click)="toggleDownloadMenu(b.id, $event)"
              [attr.aria-expanded]="openDownloadMenu() === b.id"
              [attr.aria-label]="'Opciones de descarga para ' + b.title">
              {{ b.title }}
              <span class="download-icon">▼</span>
            </button>
          </div>
        </td>
        <td>{{ b.author ?? '—' }}</td>
        <td>{{ b.genre ?? '—' }}</td>
      </tr>

      <!-- Skeleton -->
      <tr *ngIf="loading()" class="sk" aria-hidden="true">
        <td colspan="3">
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
        </td>
      </tr>
      </tbody>
    </table>

    <div class="status" *ngIf="!visibleBooks().length && !loading()" role="status" aria-live="polite">
      Sin resultados
    </div>
    <div #bottomSentinel class="sentinel" aria-hidden="true"></div>
  </div>
</div>
